<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZORRO HARDWARE | Pro POS</title>
    <style>
        :root {
            --primary: #1a252f; --accent: #f1c40f; --success: #27ae60;
            --danger: #e74c3c; --bg: #f4f7f6; --text: #334155;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { margin: 0; background: var(--bg); height: 100vh; display: flex; overflow: hidden; color: var(--text); }

        .sidebar { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; }
        .sidebar-brand { padding: 30px; font-size: 1.4rem; font-weight: bold; color: var(--accent); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-item { padding: 18px 30px; cursor: pointer; color: #bdc3c7; border-left: 4px solid transparent; transition: 0.3s; }
        .nav-item.active { background: #2c3e50; color: white; border-left-color: var(--accent); }

        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 70px; background: white; padding: 0 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        .view { display: none; flex: 1; padding: 20px; overflow: hidden; }
        .view.active { display: flex; flex-direction: column; }

        .pos-container { display: grid; grid-template-columns: 1fr 400px; gap: 20px; flex: 1; overflow: hidden; }
        .product-area { display: flex; flex-direction: column; overflow: hidden; }
        #productGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; overflow-y: auto; flex: 1; padding-bottom: 20px; }
        
        .cart-panel { background: white; border-radius: 12px; border: 1px solid #ddd; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .cart-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; }
        .cart-list { flex: 1; overflow-y: auto; padding: 0 15px; background: #fff; }
        .cart-row { display: grid; grid-template-columns: 2fr 1fr 1fr auto; padding: 12px 0; border-bottom: 1px solid #f8fafc; font-size: 0.85rem; align-items: center; }

        /* Style for the manual quantity input */
        .qty-input { width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center; }

        .payment-box { background: #fff9db; padding: 20px; border-top: 2px solid #f1c40f; flex-shrink: 0; }
        #custName { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #cashReceived { width: 100%; padding: 12px; font-size: 1.6rem; font-weight: bold; text-align: center; border: 2px solid #cbd5e1; border-radius: 8px; }
        .btn-complete { width: 100%; padding: 18px; margin-top: 10px; border: none; border-radius: 8px; font-weight: bold; color: white; background: #94a3b8; cursor: not-allowed; }
        .btn-complete.ready { background: var(--success); cursor: pointer; }

        .admin-scroll { overflow-y: auto; flex: 1; }
        .card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px; background: #f8fafc; font-size: 0.75rem; color: #64748b; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .btn-sm { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 0.75rem; }

        #loginPage { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--primary); display:flex; justify-content:center; align-items:center; z-index: 9999; }
        .login-card { background:white; padding:40px; border-radius:15px; width:380px; text-align:center; }

        @media print {
            body * { visibility: hidden; }
            #receipt-box, #receipt-box * { visibility: visible; }
            #receipt-box { display: block !important; position: absolute; left: 0; top: 0; width: 100%; max-width: 80mm; padding: 10px; font-family: 'Courier New', monospace; font-size: 10pt; background: white; }
            .r-line { display: flex; justify-content: space-between; margin-bottom: 2px; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="login-card">
            <h1>ZORRO HW</h1>
            <input type="text" id="userIn" placeholder="Username" style="width:100%; padding:12px; margin-bottom:10px;">
            <input type="password" id="passIn" placeholder="Password" style="width:100%; padding:12px; margin-bottom:20px;">
            <button onclick="handleLogin()" style="width:100%; padding:14px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer;">LOGIN</button>
        </div>
    </div>

    <div class="sidebar no-print">
        <div class="sidebar-brand">ZORRO HARDWARE</div>
        <div class="nav-item active" id="n-pos" onclick="showPage('pos')">üõí Terminal</div>
        <div class="nav-item" id="n-hist" onclick="showPage('hist')">üìã Sales & Reports</div>
        <div id="adminNav" class="nav-item" style="display:none;" onclick="showPage('stock')">üõ°Ô∏è System Admin</div>
        <div style="margin-top:auto; padding:20px;"><button onclick="location.reload()" style="width:100%; padding:8px; border:1px solid white; background:none; color:white; cursor:pointer;">Logout</button></div>
    </div>

    <div class="main no-print">
        <header>
            <h3 id="viewTitle" style="margin:0;">Terminal</h3>
            <div style="font-weight:bold; color:var(--success);">Cashier: <span id="activeUser">---</span></div>
        </header>

        <div id="posView" class="view active">
            <div class="pos-container">
                <div class="product-area">
                    <input type="text" id="posSearch" placeholder="üîç Search product..." oninput="renderPOS()" style="width:100%; padding:15px; border:1px solid #ddd; border-radius:10px; margin-bottom:20px;">
                    <div id="productGrid"></div>
                </div>
                <div class="cart-panel">
                    <div class="cart-header">Punching List</div>
                    <div class="cart-list" id="cartItems"></div>
                    <div class="payment-box">
                        <input type="text" id="custName" placeholder="Customer Name">
                        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.4rem;">
                            <span>TOTAL:</span><span id="sideTotal">‚Ç±0.00</span>
                        </div>
                        <input type="number" id="cashReceived" placeholder="Cash Received" oninput="validatePOS()">
                        <div style="display:flex; justify-content:space-between; margin-top:10px; font-weight:bold; color:var(--success);">
                            <span>CHANGE:</span><span id="sideChange">‚Ç±0.00</span>
                        </div>
                        <button onclick="processSale()" id="completeBtn" class="btn-complete">COMPLETE & PRINT</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="histView" class="view">
            <div class="admin-scroll">
                <button onclick="exportToCSV()" class="btn-sm" style="background:var(--success); color:white; padding:12px; margin-bottom:20px;">üìä Export to Excel (CSV)</button>
                <div class="card">
                    <h3>üìÜ Daily Sales</h3>
                    <table><thead><tr><th>Date</th><th>Total Sales</th><th>Action</th></tr></thead><tbody id="dailyBody"></tbody></table>
                </div>
                <div class="card">
                    <h3>üìÖ Monthly Summary</h3>
                    <table><thead><tr><th>Month</th><th>Total</th></tr></thead><tbody id="monthBody"></tbody></table>
                </div>
                <div class="card">
                    <h3>üßæ Recent Transactions</h3>
                    <table><thead><tr><th>Time</th><th>Customer</th><th>Total</th></tr></thead><tbody id="histBody"></tbody></table>
                </div>
            </div>
        </div>

        <div id="stockView" class="view">
            <div class="admin-scroll">
                <div class="card">
                    <h3>üì¶ Inventory Control</h3>
                    <input type="text" id="pName" placeholder="Item"> <input type="number" id="pPrice" placeholder="Price"> <input type="number" id="pStock" placeholder="Qty">
                    <button onclick="addProduct()" class="btn-sm" style="background:var(--success); color:white;">Add New</button>
                    <table><thead><tr><th>Item</th><th>Price</th><th>Stock</th><th>Action</th></tr></thead><tbody id="stockBody"></tbody></table>
                </div>
                <div class="card">
                    <h3>üìú Audit Logs</h3>
                    <input type="text" id="logSearch" placeholder="üîç Search logs (item, user, or action)..." oninput="refreshData()" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:6px;">
                    <table><thead><tr><th>Time</th><th>User</th><th>Item</th><th>Change</th><th>Reason</th></tr></thead><tbody id="logBody"></tbody></table>
                </div>
                <div class="card">
                    <h3>üë• Users</h3>
                    <input type="text" id="newU" placeholder="User"> <input type="password" id="newP" placeholder="Pass">
                    <button onclick="addUser()" class="btn-sm">Add User</button>
                    <table><thead><tr><th>User</th><th>Action</th></tr></thead><tbody id="userBody"></tbody></table>
                </div>
                <div class="card" style="border: 1px solid var(--danger);">
                    <h3 style="color:var(--danger);">‚ö†Ô∏è System Reset</h3>
                    <button onclick="fullSystemReset()" class="btn-sm" style="background:var(--danger); color:white; padding:10px 20px;">‚ö†Ô∏è CLEAR ALL DATA</button>
                </div>
            </div>
        </div>
    </div>

    <div id="receipt-box" style="display:none;"><div id="receipt-content"></div></div>

<script>
    let users = JSON.parse(localStorage.getItem('zh_users')) || [{u:'admin', p:'1234'}];
    let products = JSON.parse(localStorage.getItem('zh_prods')) || [];
    let sales = JSON.parse(localStorage.getItem('zh_sales')) || [];
    let logs = JSON.parse(localStorage.getItem('zh_logs')) || [];
    let cart = [], activeUser = "";

    function handleLogin() {
        const u = document.getElementById('userIn').value, p = document.getElementById('passIn').value;
        const found = users.find(x => x.u === u && x.p === p);
        if(!found) return alert("Wrong credentials");
        activeUser = u;
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('activeUser').innerText = u;
        document.getElementById('adminNav').style.display = (u.toLowerCase() === 'admin' ? 'block' : 'none');
        refreshData();
    }

    function fullSystemReset() {
        if(confirm("Wipe ALL data?")) {
            products = []; sales = []; logs = [];
            saveAll(); location.reload();
        }
    }

    function editProduct(id) {
        const p = products.find(x => x.id === id);
        const newName = prompt("Edit Item Name:", p.name);
        if(newName === null) return;
        const newPrice = prompt("Edit Item Price:", p.price);
        if(newPrice === null || isNaN(newPrice)) return;
        const oldPrice = p.price; const oldName = p.name;
        p.name = newName; p.price = parseFloat(newPrice);
        logs.unshift({time: new Date().toLocaleString(), user: activeUser, item: newName, action: `Edit`, reason: `Updated from ${oldName}(‚Ç±${oldPrice})` });
        saveAll();
    }

    function addProduct() {
        const n = document.getElementById('pName').value, pr = parseFloat(document.getElementById('pPrice').value), st = parseInt(document.getElementById('pStock').value) || 0;
        if(n && !isNaN(pr)) {
            products.push({id: Date.now(), name: n, price: pr, stock: st});
            logs.unshift({time: new Date().toLocaleString(), user: activeUser, item: n, action: `+${st}`, reason: "New Product Entry"});
            saveAll();
            document.getElementById('pName').value = ''; document.getElementById('pPrice').value = ''; document.getElementById('pStock').value = '';
        }
    }

    function addExistingStock(id) {
        const qty = prompt("Quantity to add:");
        if(!qty || isNaN(qty)) return;
        const p = products.find(x => x.id === id);
        p.stock += parseInt(qty);
        logs.unshift({time: new Date().toLocaleString(), user: activeUser, item: p.name, action: `+${qty}`, reason: "Restock"});
        saveAll();
    }

    function renderPOS() {
        const s = document.getElementById('posSearch').value.toLowerCase();
        document.getElementById('productGrid').innerHTML = products.filter(p => p.name.toLowerCase().includes(s)).map(p => `
            <div style="background:white; padding:12px; border-radius:8px; border:1px solid #eee; text-align:center; cursor:pointer;" onclick="addToCart(${p.id})">
                <b>${p.name}</b><br>‚Ç±${p.price.toFixed(2)}<br><small>Stock: ${p.stock}</small>
            </div>`).join('');
    }

    function addToCart(id) {
        const p = products.find(x => x.id === id);
        if(p.stock <= 0) return alert("Out of stock");
        const ex = cart.find(c => c.id === id);
        if(ex) { if(ex.qty < p.stock) ex.qty++; } else { cart.push({...p, qty:1}); }
        updateCart();
    }

    // Logic for manual quantity update in punching list
    function updateManualQty(index, val) {
        const qty = parseInt(val);
        if (isNaN(qty) || qty < 1) {
            cart[index].qty = 1;
        } else {
            const originalProduct = products.find(p => p.id === cart[index].id);
            if (qty > originalProduct.stock) {
                alert(`Insufficient stock. Only ${originalProduct.stock} available.`);
                cart[index].qty = originalProduct.stock;
            } else {
                cart[index].qty = qty;
            }
        }
        updateCart();
    }

    function updateCart() {
        document.getElementById('cartItems').innerHTML = cart.map((c, i) => `
            <div class="cart-row">
                <div>${c.name}</div>
                <div><input type="number" class="qty-input" value="${c.qty}" onchange="updateManualQty(${i}, this.value)"></div>
                <div>‚Ç±${(c.price*c.qty).toFixed(2)}</div>
                <button onclick="cart.splice(${i},1);updateCart()" style="color:red; border:none; background:none; cursor:pointer;">‚úï</button>
            </div>`).join('');
        validatePOS();
    }

    function validatePOS() {
        const total = cart.reduce((s, i) => s + (i.price*i.qty), 0);
        const cash = parseFloat(document.getElementById('cashReceived').value) || 0;
        document.getElementById('sideTotal').innerText = "‚Ç±" + total.toFixed(2);
        document.getElementById('sideChange').innerText = "‚Ç±" + Math.max(0, cash - total).toFixed(2);
        const btn = document.getElementById('completeBtn');
        if(cart.length > 0 && cash >= total && total > 0) btn.classList.add('ready');
        else btn.classList.remove('ready');
    }

    function processSale() {
        const total = cart.reduce((s, i) => s + (i.price*i.qty), 0);
        const cash = parseFloat(document.getElementById('cashReceived').value);
        const customer = document.getElementById('custName').value || "Walk-in";
        if(!cart.length || isNaN(cash) || cash < total) return;
        const now = new Date();
        const html = `
            <center><strong>ZORRO HARDWARE</strong><br>Receipt<br>-------------------------</center>
            Date: ${now.toLocaleString()}<br>Cashier: ${activeUser}<br>Customer: ${customer}<br>
            -------------------------
            ${cart.map(i => `<div class="r-line"><span>${i.name} x${i.qty}</span><span>${(i.price*i.qty).toFixed(2)}</span></div>`).join('')}
            -------------------------
            <div class="r-line"><strong>TOTAL:</strong> <strong>‚Ç±${total.toFixed(2)}</strong></div>
            <div class="r-line"><span>CASH:</span> <span>‚Ç±${cash.toFixed(2)}</span></div>
            <div class="r-line"><span>CHANGE:</span> <span>‚Ç±${(cash-total).toFixed(2)}</span></div>
        `;
        document.getElementById('receipt-content').innerHTML = html; window.print();
        cart.forEach(c => { 
            const p = products.find(x => x.id === c.id); p.stock -= c.qty; 
            logs.unshift({time: now.toLocaleString(), user: activeUser, item: p.name, action: `-${c.qty}`, reason: "Sale"});
        });
        sales.unshift({ time: now.toLocaleString(), dateOnly: now.toLocaleDateString(), monthOnly: now.toLocaleString('default', { month: 'short', year: 'numeric' }), customer, total, itemsSold: [...cart] });
        cart = []; document.getElementById('cashReceived').value = ''; document.getElementById('custName').value = '';
        saveAll();
    }

    function printDailyReport(date) {
        const daySales = sales.filter(s => s.dateOnly === date);
        const totalCash = daySales.reduce((sum, s) => sum + s.total, 0);
        const groupedItems = {};
        daySales.forEach(s => { if (s.itemsSold) { s.itemsSold.forEach(item => { groupedItems[item.name] = (groupedItems[item.name] || 0) + item.qty; }); } });
        const html = `
            <center><strong>ZORRO HARDWARE</strong><br>DAILY SALES SUMMARY<br>Date: ${date}<br>-------------------------</center>
            <strong>ITEMS SOLD:</strong><br>
            ${Object.keys(groupedItems).map(name => `<div class="r-line"><span>${name}</span><span>x${groupedItems[name]}</span></div>`).join('')}
            -------------------------
            <div class="r-line"><strong>TOTAL CASH:</strong> <strong>‚Ç±${totalCash.toFixed(2)}</strong></div>
        `;
        document.getElementById('receipt-content').innerHTML = html; window.print();
    }

    function exportToCSV() {
        let csv = "Date,Time,Customer,Total\n";
        sales.forEach(s => csv += `"${s.dateOnly}","${s.time.split(',')[1]}","${s.customer}","${s.total}"\n`);
        const blob = new Blob([csv], {type:'text/csv'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Zorro_Sales.csv'; a.click();
    }

    function saveAll() {
        localStorage.setItem('zh_users', JSON.stringify(users));
        localStorage.setItem('zh_prods', JSON.stringify(products));
        localStorage.setItem('zh_sales', JSON.stringify(sales));
        localStorage.setItem('zh_logs', JSON.stringify(logs));
        refreshData();
    }

    function refreshData() {
        renderPOS(); 
        // We only call updateCart if the cart has items to avoid resetting manual input focus 
        // but for this simple version, standard refresh is fine.
        updateCart();
        document.getElementById('userBody').innerHTML = users.map((u, i) => `<tr><td>${u.u}</td><td><button onclick="if(i>0){users.splice(${i},1);saveAll();}">Del</button></td></tr>`).join('');
        document.getElementById('stockBody').innerHTML = products.map(p => `<tr><td>${p.name}</td><td>‚Ç±${p.price.toFixed(2)}</td><td>${p.stock}</td><td>
            <button onclick="addExistingStock(${p.id})" class="btn-sm" style="background:var(--success); color:white;">+ Stock</button>
            <button onclick="editProduct(${p.id})" class="btn-sm" style="background:var(--primary); color:white;">Edit</button>
            <button onclick="if(confirm('Delete?')){products=products.filter(x=>x.id!==${p.id});saveAll();}" class="btn-sm" style="background:var(--danger); color:white;">Del</button>
        </td></tr>`).join('');
        
        const lSearch = document.getElementById('logSearch').value.toLowerCase();
        const filteredLogs = logs.filter(l => 
            l.item.toLowerCase().includes(lSearch) || 
            l.user.toLowerCase().includes(lSearch) || 
            l.reason.toLowerCase().includes(lSearch)
        );

        document.getElementById('logBody').innerHTML = filteredLogs.slice(0, 30).map(l => `<tr><td><small>${l.time}</small></td><td>${l.user}</td><td>${l.item}</td><td style="color:${l.action.includes('-')?'red':'green'}"><b>${l.action}</b></td><td>${l.reason}</td></tr>`).join('');
        document.getElementById('histBody').innerHTML = sales.slice(0, 5).map(s => `<tr><td><small>${s.time}</small></td><td>${s.customer}</td><td>‚Ç±${s.total.toFixed(2)}</td></tr>`).join('');
        const dailyMap = {};
        sales.forEach(s => { dailyMap[s.dateOnly] = (dailyMap[s.dateOnly] || 0) + s.total; });
        document.getElementById('dailyBody').innerHTML = Object.keys(dailyMap).map(d => `<tr><td>${d}</td><td>‚Ç±${dailyMap[d].toFixed(2)}</td><td><button onclick="printDailyReport('${d}')" class="btn-sm" style="background:var(--primary); color:white;">Print Report</button></td></tr>`).join('');
        document.getElementById('monthBody').innerHTML = [...new Set(sales.map(s => s.monthOnly))].map(m => {
            const total = sales.filter(s => s.monthOnly === m).reduce((a, b) => a + b.total, 0);
            return `<tr><td>${m}</td><td>‚Ç±${total.toFixed(2)}</td></tr>`;
        }).join('');
    }

    function showPage(p) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(p + 'View').classList.add('active');
        document.querySelectorAll('.nav-item').forEach(v => v.classList.remove('active'));
        document.getElementById('n-' + (p === 'stock' ? 'stock' : p))?.classList.add('active');
    }
</script>
</body>
</html>